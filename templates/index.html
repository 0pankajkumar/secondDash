{% extends "cover.html" %}


{% block main %}

<h1 style="text-align: center">The Dashboard
  <small>Beta</small>
</h1>



<form style="text-align: center" id="bigForm">

  <div class="ui-widget">
    <label for="companyName">Company:</label>
    <select name="ddl1" id="ddl1" style="display: hidden"
      onchange="configureDDL2(this, document.getElementById('ddl2'), document.getElementById('ddl3'))">
      <option value="All" selected>All</option>
      {% for p in postingDepartment %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>
  </div>



  <div class="ui-widget">
    <label for="postingTeam">Team:</label>
    <select name="ddl2" id="ddl2" style="display: hidden"
      onchange="configureDDL3(document.getElementById('ddl1'), this, document.getElementById('ddl3'))">
      <option value="All" selected>All</option>
    </select>
  </div>


  <div class="ui-widget">
    <label for="postingTitle">Title:</label>
    <select name="ddl3" id="ddl3" style="display: hidden">
      <option value="All" selected>All</option>
    </select>
  </div>


  <div class="ui-widget">
    <label for="  ">Posting Archived :</label>
    <select name="postingArchiveStatus" id="postingArchiveStatus" style="display: hidden">
      <option value="Both" selected>Both</option>
      {% for p in postingArchiveStatus %}
      {% if p == 'false' %}
      <option value="{{ p }}">No</option>
      {% elif p == 'true' %}
      <option value="{{ p }}">Yes</option>
      {% else %}
      <option value="{{ p }}">{{ p }}</option>
      {% endif %}
      {% endfor %}
    </select>
  </div>

  <div class="ui-widget">
    <label for="">Age:</label>
    <select name="age" id="age" style="display: hidden">
      <option value="beginningOfTime" selected>Beginning of Time</option>
      <option value="3 Days Old">3 Days Old</option>
      <option value="7 Days Old">7 Days Old</option>
      <option value="15 Days Old">15 Days Old</option>
      <option value="1 Months Old">1 Month Old</option>
      <option value="2 Months Old">2 Months Old</option>
      <option value="3 Months Old">3 Months Old</option>
      <option value="4 Months Old">4 Months Old</option>
      <option value="6 Months Old">6 Months Old</option>
    </select>
  </div>

  &nbsp &nbsp
  <button id="send" class="btn btn-primary">Go</button>
</form>

<script>

  //Ajax call to load the bigDict
  $(document).ready(function () {
    $.ajax({
      type: "GET",
      cache: true,
      url: "/getBigDict",
      data: "", //ajax parameters
      success: function (result) {
        console.log(result)
        myNestedVals = result;
        // document.getElementById('ddl1').style.display = 'inline';
        // document.getElementById('ddl2').style.display = 'inline';
        // document.getElementById('ddl3').style.display = 'inline';
        // document.getElementById('postingArchiveStatus').style.display = 'inline';
        // document.getElementById('age').style.display = 'inline';
      }
    });

  });


  //Code inspired from http://benalexkeen.com/auto-updating-dropdown-fields-in-javascript/
  function createOption(ddl, text, value) {
    var opt = document.createElement('option');
    opt.value = value;
    opt.text = text;
    ddl.options.add(opt);
  }

  function createOptions(optionsArray, ddl) {
    optionsArray.sort();
    for (i = 0; i < optionsArray.length; i++) {
      createOption(ddl, optionsArray[i], optionsArray[i]);
    }
  }

  function configureDDL2(ddl1, ddl2, ddl3) {
    ddl2.options.length = 0;
    ddl3.options.length = 0;
    createOption(ddl2, "All", "All");
    var ddl2keys = Object.keys(myNestedVals[ddl1.value]);
    createOptions(ddl2keys, ddl2);

  }

  function configureDDL3(ddl1, ddl2, ddl3) {
    ddl3.options.length = 0;
    createOption(ddl3, "All", "All");
    var ddl3keys = myNestedVals[ddl1.value][ddl2.value];
    createOptions(ddl3keys, ddl3);
  }


</script>


<div id="example-table" style="margin: 20px"></div>

<script type="text/javascript">

  $('#send').on('click', function (e) {
    e.preventDefault();
    var x = getFormData($('#bigForm'));

    // Nested calculator of TOTAL for each posting
    var nestedCalc = function (values, data, calcParams) {
      var calc = 0;

      data.forEach(function (row) {
        row._children.forEach(function (child) {
          calc += child[calcParams.field];
        })
      });

      return calc;
    }

    // Rewriting the heading of Posting name
    var customGroupHeader = function (value, count, data, group) {
      return value + "<span style='color:#d00; margin-left:10px;'></span>";
    }

    // Creating a Tabulator object
    var table = new Tabulator("#example-table", {
      ajaxURL: "http://localhost:5000/getTable", //ajax URL
      ajaxParams: { "companyName": x['ddl1'], "postingTeam": x['ddl2'], "postingTitle": x['ddl3'], "postingArchiveStatus": x['postingArchiveStatus'], "age": x['age'] }, //ajax parameters
      ajaxConfig: "POST", //ajax HTTP request type
      // type:"GET", //set request type to Position
      contentType: 'application/json; charset=utf-8',
      height: "auto",
      layout: "fitColumns",
      placeholder: "No Data",
      index: "id",
      dataTree: true,
      dataTreeStartExpanded: true,
      groupBy: "Posting ID",
      groupHeader: customGroupHeader,
      columns: [
        { title: "Posting", field: "origin", width: 200, responsive: 0 },
        // { title: "Origin", field: "origin", width: 150 },
        { title: "New Lead", field: "newLeadCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "newLeadCount" } },
        { title: "Reached Out", field: "reachedOutCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "reachedOutCount" } },
        { title: "New applicant", field: "newApplicantCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "newApplicantCount" } },
        { title: "Recruiter Screen", field: "recruiterScreenCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "recruiterScreenCount" } },
        { title: "Phone Interview", field: "phoneInterviewCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "phoneInterviewCount" } },
        { title: "On-site", field: "onsiteInterviewCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "onsiteInterviewCount" } },
        { title: "Offer", field: "offerCount", bottomCalc: nestedCalc, bottomCalcParams: { field: "offerCount" } },
      ],


    });


    function getFormData($form) {
      var unindexed_array = $form.serializeArray();
      var indexed_array = {};

      $.map(unindexed_array, function (n, i) {
        indexed_array[n['name']] = n['value'];
      });

      return indexed_array;
    }
  });

</script>


{% endblock %}